name: Build → Push images → Deploy (docker hub + self-hosted)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  QUASAR_ROOT: frontend
  DOTNET_PROJECT_PATH: backend
  NODE_VERSION: '20.x'
  DOTNET_VERSION: '8.0'

jobs:
  build_and_push_images:
    name: Build frontend & backend, build images and push
    runs-on: ubuntu-latest
    outputs:
      frontend_image: ${{ steps.set_images.outputs.frontend_image }}
      backend_image: ${{ steps.set_images.outputs.backend_image }}
      frontend_repo: ${{ steps.set_images.outputs.frontend_repo }}
      backend_repo: ${{ steps.set_images.outputs.backend_repo }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - id: set_images
        name: Set image names (lowercase) & tags
        run: |
          BASE="$(echo "${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')"
          FRONT_REPO="${BASE}-frontend"
          BACK_REPO="${BASE}-backend"
          FRONT_TAG="${FRONT_REPO}:${{ github.sha }}"
          BACK_TAG="${BACK_REPO}:${{ github.sha }}"
          echo "frontend_repo=${FRONT_REPO}" >> $GITHUB_OUTPUT
          echo "backend_repo=${BACK_REPO}" >> $GITHUB_OUTPUT
          echo "frontend_image=${FRONT_TAG}" >> $GITHUB_OUTPUT
          echo "backend_image=${BACK_TAG}" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ---------- FRONTEND: build Quasar SPA ----------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache frontend node_modules
        id: cache-npm
        uses: actions/cache@v4
        with:
          path: ${{ env.QUASAR_ROOT }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles(format('{0}/package-lock.json', env.QUASAR_ROOT)) }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install frontend deps (if cache miss)
        if: steps.cache-npm.outputs.cache-hit != 'true'
        run: npm ci
        working-directory: ${{ env.QUASAR_ROOT }}

      - name: Install Quasar CLI
        run: npm install -g @quasar/cli

      - name: Build Quasar SPA (dist)
        run: quasar build -m spa --output-path dist
        working-directory: ${{ env.QUASAR_ROOT }}

      - name: Prepare frontend image context
        run: |
          rm -rf /tmp/frontend-image
          mkdir -p /tmp/frontend-image/dist
          cp -r ${{ env.QUASAR_ROOT }}/dist/* /tmp/frontend-image/dist/
          cat > /tmp/frontend-image/Dockerfile <<'EOF'
          FROM nginx:stable-alpine
          RUN rm -rf /usr/share/nginx/html/*
          COPY dist/ /usr/share/nginx/html/
          EXPOSE 80
          CMD ["nginx", "-g", "daemon off;"]
          EOF

      # ---------- BACKEND: dotnet publish ----------
      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore and publish .NET app
        run: |
          cd ${{ env.DOTNET_PROJECT_PATH }}
          dotnet restore
          dotnet publish -c Release -o publish
        working-directory: ${{ github.workspace }}

      - name: Prepare backend image context
        run: |
          if [ ! -d /tmp/backend-image ]; then rm -rf /tmp/backend-image; fi
          mkdir -p /tmp/backend-image/app
          cp -r ${{ env.DOTNET_PROJECT_PATH }}/publish/* /tmp/backend-image/app/
          cat > /tmp/backend-image/Dockerfile <<'EOF'
          FROM mcr.microsoft.com/dotnet/aspnet:8.0
          WORKDIR /app
          COPY app/ .
          ENV ASPNETCORE_URLS=http://+:8080
          EXPOSE 8080
          ENTRYPOINT ["dotnet", "Your.Web.App.dll"]
          EOF
          # NOTE: Replace Your.Web.App.dll with your actual DLL or commit a backend/Dockerfile and adjust workflow to use it.

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push frontend image (sha & latest)
        uses: docker/build-push-action@v5
        with:
          context: /tmp/frontend-image
          file: /tmp/frontend-image/Dockerfile
          push: true
          tags: |
            ${{ steps.set_images.outputs.frontend_image }}
            ${{ steps.set_images.outputs.frontend_repo }}:latest

      - name: Build & push backend image (sha & latest)
        uses: docker/build-push-action@v5
        with:
          context: /tmp/backend-image
          file: /tmp/backend-image/Dockerfile
          push: true
          tags: |
            ${{ steps.set_images.outputs.backend_image }}
            ${{ steps.set_images.outputs.backend_repo }}:latest

  deploy_to_self_hosted:
    name: Pull fresh images on self-hosted and run compose
    runs-on: [self-hosted, linux]
    needs: build_and_push_images
    environment: Production
  
    steps:
      - name: Checkout (for docker-compose.yml if you keep it in repo)
        uses: actions/checkout@v4
  
      - name: Log in to Docker Hub (self-hosted)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
  
      - name: Compute image names (recompute here to avoid empty job outputs)
        id: compute_images
        run: |
          # ensure secret exists
          if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "ERROR: DOCKER_USERNAME secret is empty or missing"
            exit 1
          fi
  
          BASE="$(echo "${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')"
          FRONT="${BASE}-frontend:${{ github.sha }}"
          BACK="${BASE}-backend:${{ github.sha }}"
  
          # trim whitespace/newlines just in case
          FRONT="$(echo -n "$FRONT" | tr -d '\r\n' | xargs || true)"
          BACK="$(echo -n "$BACK" | tr -d '\r\n' | xargs || true)"
  
          echo "frontend_image=$FRONT" >> $GITHUB_OUTPUT
          echo "backend_image=$BACK"  >> $GITHUB_OUTPUT
  
          echo "DEBUG: computed frontend image -> '$FRONT'"
          echo "DEBUG: computed backend  image -> '$BACK'"
  
      - name: Create image-based docker-compose.deploy.yml (quote image values)
        run: |
          FRONT="${{ steps.compute_images.outputs.frontend_image }}"
          BACK="${{ steps.compute_images.outputs.backend_image }}"
  
          cat > docker-compose.deploy.yml <<EOF
          version: '3.8'
          services:
            frontend:
              image: "${FRONT}"
              container_name: frontend
              ports:
                - "80:80"
              depends_on:
                - backend
              networks:
                - app-network
  
            backend:
              image: "${BACK}"
              container_name: backend
              ports:
                - "8080:8080"
              depends_on:
                db:
                  condition: service_healthy
              networks:
                - app-network
  
            db:
              image: mcr.microsoft.com/mssql/server:latest
              container_name: mssql
              environment:
                SA_PASSWORD: "${{ secrets.MSSQL_SA_PASSWORD }}"
                ACCEPT_EULA: "Y"
              ports:
                - "1433:1433"
              volumes:
                - mssql-data:/var/opt/mssql
              healthcheck:
                test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P \"${{ secrets.MSSQL_SA_PASSWORD }}\" -Q \"SELECT 1\" || exit 1"]
                interval: 10s
                timeout: 5s
                retries: 5
              networks:
                - app-network
  
          networks:
            app-network:
              driver: bridge
  
          volumes:
            mssql-data:
          EOF
  
      - name: Show generated compose file (debug)
        run: |
          echo "---- docker-compose.deploy.yml ----"
          sed -n '1,200p' docker-compose.deploy.yml || true
          echo "-----------------------------------"
  
      - name: Show docker / compose versions (debug)
        run: |
          docker --version || true
          docker compose version || docker-compose --version || true
  
      - name: Stop existing stack (if any)
        run: docker compose -f docker-compose.deploy.yml down --remove-orphans || true
  
      - name: Pull images & start stack
        run: |
          docker compose -f docker-compose.deploy.yml pull || true
          docker compose -f docker-compose.deploy.yml up -d --remove-orphans
