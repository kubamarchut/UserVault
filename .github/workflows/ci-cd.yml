name: Build → Push images → Deploy (docker hub + self-hosted)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  QUASAR_ROOT: frontend
  DOTNET_PROJECT_PATH: backend
  NODE_VERSION: '20.x'
  DOTNET_VERSION: '8.0'

jobs:
  build_and_push_images:
    name: Build frontend & backend, push to Docker Hub
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Normalize repository name
        id: normalize
        run: |
          BASE=$(echo "${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          echo "base_repo=$BASE" >> $GITHUB_OUTPUT
          echo "frontend_image=${BASE}-frontend:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "backend_image=${BASE}-backend:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "DEBUG frontend: ${BASE}-frontend:${{ github.sha }}"
          echo "DEBUG backend:  ${BASE}-backend:${{ github.sha }}"

      # ---------- Build & push frontend image ----------
      - name: Build & push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ steps.normalize.outputs.base_repo }}-frontend:${{ github.sha }}
            ${{ steps.normalize.outputs.base_repo }}-frontend:latest

      # ---------- Build & push backend image ----------
      - name: Build & push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ steps.normalize.outputs.base_repo }}-backend:${{ github.sha }}
            ${{ steps.normalize.outputs.base_repo }}-backend:latest

  deploy_to_self_hosted:
    name: Pull fresh images on self-hosted and run compose
    runs-on: [self-hosted, linux]
    needs: build_and_push_images
    environment: Production
  
    steps:
      - name: Checkout (for docker-compose.yml if you keep it in repo)
        uses: actions/checkout@v4
  
      - name: Log in to Docker Hub (self-hosted)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
  
      - name: Compute image names (recompute here to avoid empty job outputs)
        id: compute_images
        run: |
          # ensure secret exists
          if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "ERROR: DOCKER_USERNAME secret is empty or missing"
            exit 1
          fi
  
          BASE="$(echo "${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')"
          FRONT="${BASE}-frontend:${{ github.sha }}"
          BACK="${BASE}-backend:${{ github.sha }}"
  
          # trim whitespace/newlines just in case
          FRONT="$(echo -n "$FRONT" | tr -d '\r\n' | xargs || true)"
          BACK="$(echo -n "$BACK" | tr -d '\r\n' | xargs || true)"
  
          echo "frontend_image=$FRONT" >> $GITHUB_OUTPUT
          echo "backend_image=$BACK"  >> $GITHUB_OUTPUT
  
          echo "DEBUG: computed frontend image -> '$FRONT'"
          echo "DEBUG: computed backend  image -> '$BACK'"
  
      - name: Create image-based docker-compose.deploy.yml (quote image values)
        run: |
          FRONT="${{ steps.compute_images.outputs.frontend_image }}"
          BACK="${{ steps.compute_images.outputs.backend_image }}"
  
          cat > docker-compose.deploy.yml <<EOF
          version: '3.8'
          services:
            frontend:
              image: "${FRONT}"
              container_name: frontend
              ports:
                - "3003:80"
              depends_on:
                - backend
              networks:
                - app-network
  
            backend:
              image: "${BACK}"
              container_name: backend
              ports:
                - "8080:8080"
              depends_on:
                db:
                  condition: service_healthy
              networks:
                - app-network
            db:
              image: mcr.microsoft.com/mssql/server:latest
              container_name: mssql
              environment:
                SA_PASSWORD: "${{ secrets.MSSQL_SA_PASSWORD }}"
                ACCEPT_EULA: "Y"
              ports:
                - "1433:1433"
              networks:
                - app-network
              volumes:
                - ./init:/usr/src/app/init
                - mssql-data:/var/opt/mssql
              command: 
                - /bin/bash
                - -c
                - |
                  /opt/mssql/bin/sqlservr &
                  /usr/src/app/init/init-db.sh &
                  wait
              healthcheck:
                test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P \"${{ secrets.MSSQL_SA_PASSWORD }}\" -Q \"SELECT 1\" || exit 1"]
                interval: 10s
                timeout: 5s
                retries: 5
  
          networks:
            app-network:
              driver: bridge
  
          volumes:
            mssql-data:
          EOF
  
      - name: Show generated compose file (debug)
        run: |
          echo "---- docker-compose.deploy.yml ----"
          sed -n '1,200p' docker-compose.deploy.yml || true
          echo "-----------------------------------"
  
      - name: Show docker / compose versions (debug)
        run: |
          docker --version || true
          docker compose version || docker-compose --version || true
  
      - name: Stop existing stack (if any)
        run: docker compose -f docker-compose.deploy.yml down --remove-orphans || true
  
      - name: Pull images & start stack
        run: |
          docker compose -f docker-compose.deploy.yml pull || true
          docker compose -f docker-compose.deploy.yml up -d --remove-orphans
